(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{206:function(t,s,a){t.exports=a.p+"assets/img/restful.359c1584.png"},231:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"egg基础概念"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#egg基础概念"}},[t._v("#")]),t._v(" egg基础概念")]),t._v(" "),n("h2",{attrs:{id:"内置对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内置对象"}},[t._v("#")]),t._v(" 内置对象")]),t._v(" "),n("h3",{attrs:{id:"继承自koa的内置对象："}},[n("a",{staticClass:"header-anchor",attrs:{href:"#继承自koa的内置对象："}},[t._v("#")]),t._v(" 继承自Koa的内置对象：")]),t._v(" "),n("ul",[n("li",[t._v("Application : 全局应用对象，在一个应用中，只会实例化一个，允许在它上面挂载一些全局方法和对象。在编写应用时，几乎在任何一个地方都能获取Application对象。")]),t._v(" "),n("li",[t._v("Context :最常见的获取方式是在Middleware,Controller,以及Service中；Controller中的获取Context ; Service中获取Context; Middleware中获取Context")]),t._v(" "),n("li",[t._v("Request ：Request 是一个请求级别的对象，与Koa一样，Egg中会在Context上代理一部分Request和Response上的方法和属性。")]),t._v(" "),n("li",[t._v("Response： Response是一个请求级别的对象。"),n("br"),t._v("\nctx.request.query和ctx.query是等价的，ctx.response.body和ctx.body是等价的。"),n("br"),t._v("\n获取请求对象的body应该使用ctx.request.body ,而不是ctx.body;")])]),t._v(" "),n("h3",{attrs:{id:"egg自身扩展的对象："}},[n("a",{staticClass:"header-anchor",attrs:{href:"#egg自身扩展的对象："}},[t._v("#")]),t._v(" Egg自身扩展的对象：")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("Controller :Egg提供了一个Controller基类，并推荐所有的Controller继承于该基类实现。")])]),t._v(" "),n("li",[n("p",[t._v("Service： Egg提供了一个Service基类，并推荐所有的Service继承于该基类实现。"),n("br"),t._v("\n这两个基类都有如下属性： ctx:当前请求的上下文实例。app:应用的Application 实例。config：应用的配置项。service：应用所有的Service。 controller:应用所有的controller。 logger：为当前实例封装的logger对象。")])]),t._v(" "),n("li",[n("p",[t._v("Helper：Helper用来提供一些实用的utility函数。我们可以将一些常用的动作抽离在helper.js里面成为一个独立的函数。在Context的实例上获取到当前请求的Helper实例。Helper实例还可以在模板中获取到。")])]),t._v(" "),n("li",[n("p",[t._v("Config：Egg推荐应用开发遵循配置和代码分离的原则。配置文件支持各个不同的运行环境使用不同的配置。所有框架、插件和应用级别的配置都可以通过Config对象获取到。")])]),t._v(" "),n("li",[n("p",[t._v("Logger： Logger对象有4个方法：logger.debug()、logger.info()、logger.warn()、logger.error();"),n("br"),t._v("\n在框架中提供了多个Logger对象：")])]),t._v(" "),n("li",[n("p",[t._v("App CoreLogger: 框架和插件需要通过它来打印应用级别的日志。")])]),t._v(" "),n("li",[n("p",[t._v("Context Logger：与请求相关的，在前面带上一些当前请求相关的信息。")])]),t._v(" "),n("li",[n("p",[t._v("Context CoreLogger： 一般只有插件和框架会通过它来记录请求日志。")])]),t._v(" "),n("li",[n("p",[t._v("Controller Logger和Service Logger：其本质是一个Context Logger。")])])]),t._v(" "),n("h2",{attrs:{id:"运行环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行环境"}},[t._v("#")]),t._v(" 运行环境")]),t._v(" "),n("h3",{attrs:{id:"运行环境指定和获取"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#运行环境指定和获取"}},[t._v("#")]),t._v(" 运行环境指定和获取")]),t._v(" "),n("p",[t._v("配置环境的两种方式：")]),t._v(" "),n("ul",[n("li",[t._v("通过config/env文件指定，该文件的内容就是运行环境：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//config/env  (文件在config文件夹下，名叫env的文件，文件里只写环境名称，不可以写注释)")]),t._v("\nprod\n")])])]),n("ul",[n("li",[t._v("通过'EGG_SERVER_ENV' 环境变量指定运行环境更加方便，比如在生产环境启动应用：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("EGG_SERVER_ENV")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("prod npm start\n")])])]),n("p",[t._v("框架提供了变量app.config.env 来表示应用当前的运行环境。")]),t._v(" "),n("p",[t._v("一个web应用本身应该是无状态的，并拥有根据运行环境设置自身的能力。")]),t._v(" "),n("h3",{attrs:{id:"egg-server-env"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#egg-server-env"}},[t._v("#")]),t._v(" EGG_SERVER_ENV")]),t._v(" "),n("ul",[n("li",[t._v("很多node.js应用会使用NODE_ENV 来区分运行环境。")]),t._v(" "),n("li",[t._v("npm也会使用这个变量，在应用部署的时候一般不会安装开发依赖；")]),t._v(" "),n("li",[t._v("Egg支持自定义环境来适应自己的开发流程。")]),t._v(" "),n("li",[t._v("在Koa中我们通过app.env来进行判断，在Egg中，配置统一都放置在app.config 上；")])]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",{staticStyle:{"text-align":"center"}},[t._v("NODE_ENV")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("EGG_SERVER_ENV")]),t._v(" "),n("th",{staticStyle:{"text-align":"center"}},[t._v("注解")])])]),t._v(" "),n("tbody",[n("tr",[n("td",{staticStyle:{"text-align":"center"}}),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("local")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("本地开发环境")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("test")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("unittest")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("单元测试")])]),t._v(" "),n("tr",[n("td",{staticStyle:{"text-align":"center"}},[t._v("production")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("prod")]),t._v(" "),n("td",{staticStyle:{"text-align":"center"}},[t._v("生产环境")])])])]),t._v(" "),n("h2",{attrs:{id:"目录结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#目录结构"}},[t._v("#")]),t._v(" 目录结构")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://eggjs.org/zh-cn/basics/structure.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("egg项目目录结构"),n("OutboundLink")],1),t._v("；")]),t._v(" "),n("h1",{attrs:{id:"基础功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基础功能"}},[t._v("#")]),t._v(" 基础功能")]),t._v(" "),n("h2",{attrs:{id:"路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#路由"}},[t._v("#")]),t._v(" 路由")]),t._v(" "),n("ul",[n("li",[t._v("Router主要用来描述请求URL和具体承担执行动作的Controller的对应关系，框架约定了app/router.js文件用于统一所有路由规则。")]),t._v(" "),n("li",[t._v("通过统一的配置，我们可以避免路由规则逻辑散落在多个地方，从而出现未知的冲突，集中在一起我们可以更方便的来查看全局的路由规则。")])]),t._v(" "),n("h3",{attrs:{id:"路由定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#路由定义"}},[t._v("#")]),t._v(" 路由定义")]),t._v(" "),n("ul",[n("li",[t._v("app/router.js里面定义URL路由规则")]),t._v(" "),n("li",[t._v("app/controller 目录下面实现Controller")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 路由js的样例。")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("app")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" router"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" controller "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\trouter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("home"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\trouter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/getHelloInfo'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("home"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hello"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h4",{attrs:{id:"路由的详细定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#路由的详细定义"}},[t._v("#")]),t._v(" 路由的详细定义")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// verb-用户触发动作，支持GET，POST等所有HTTP方法")]),t._v("\nrouter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("verb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path-match'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("action "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// router-name给路由设定一个别名。 path-match -路由URL；")]),t._v("\nrouter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("verb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'router-name'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path-match'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// middleware -在Router里面可以配置多个Middleware。 controller -指定路由映射到的具体controller上。")]),t._v("\nrouter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("verb")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'router-name'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path-match'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("middleware1 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("middleware2 "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" …… "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" middlewareN "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("action"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),n("h3",{attrs:{id:"restful风格api定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#restful风格api定义"}},[t._v("#")]),t._v(" RESTful风格API定义")]),t._v(" "),n("p",[t._v("Egg提供了app.router.resources快速在一个路径上生成一个CRUD路由结构。\n"),n("img",{attrs:{src:a(206),alt:"restful风格api"}}),t._v(";")]),t._v(" "),n("h2",{attrs:{id:"控制器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#控制器"}},[t._v("#")]),t._v(" 控制器")]),t._v(" "),n("h3",{attrs:{id:"什么是controller"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是controller"}},[t._v("#")]),t._v(" 什么是Controller")]),t._v(" "),n("p",[t._v("Egg通过Router将用户的请求基于method和url分发到了对应的Controller上，简单的说Controller负责解析用户的输入，处理后返回相应的结果。")]),t._v(" "),n("ul",[n("li",[t._v("在RESTful接口中，Controller接受用户的参数，从数据库中查找内容返回给用户或者将用户的请求更新到数据库中。")]),t._v(" "),n("li",[t._v("在HTML页面请求中，Controller根据用户访问不同的URL，渲染不同的模板得到HTML返回给用户。")]),t._v(" "),n("li",[t._v("在代理服务器中，Controller将用户的请求转发到其他服务器上，并将其他服务器的处理结果返回给用户。")])]),t._v(" "),n("h3",{attrs:{id:"controller负责做什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#controller负责做什么"}},[t._v("#")]),t._v(" Controller负责做什么")]),t._v(" "),n("p",[t._v("框架推荐Controller层主要对用户的请求参数进行处理，然后调用对应的Service方法处理业务，得到业务结果后封装并返回。")]),t._v(" "),n("ul",[n("li",[t._v("1、获取用户通过HTTP传递过来的请求参数。")]),t._v(" "),n("li",[t._v("2、校验、组装参数。")]),t._v(" "),n("li",[t._v("3、调用Service进行业务处理，必要时处理转换Service的返回结果，让它适应用户的需求。")]),t._v(" "),n("li",[t._v("4、通过HTTP将结果响应给用户。")])]),t._v(" "),n("h3",{attrs:{id:"controller的定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#controller的定义"}},[t._v("#")]),t._v(" Controller的定义")]),t._v(" "),n("p",[t._v("定义Controller类，会在每一个请求进来的时候实例化一个全新的对象，会有下面几个属性挂在this上：")]),t._v(" "),n("ul",[n("li",[t._v("this.ctx :当前请求的上下文Context对象的实例")]),t._v(" "),n("li",[t._v("this.app  ：当前应用Application对象的实例")]),t._v(" "),n("li",[t._v("this.service :应用定的Service；")]),t._v(" "),n("li",[t._v("this.config  ：应用运行时的配置项。")]),t._v(" "),n("li",[t._v("this.logger  ：logger对象，上面有四个方法。")])]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("所有的Controller文件都必须放在app/controller 目录下。")])]),t._v(" "),n("h4",{attrs:{id:"controller类的写法："}},[n("a",{staticClass:"header-anchor",attrs:{href:"#controller类的写法："}},[t._v("#")]),t._v(" Controller类的写法：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Controller "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HomeController")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Controller")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   \t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ctx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   \t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实现用户参数获取，校验、组装参数等；调用service进行业务处理，通过http将结果返回给用户。")]),t._v("\n   \tctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hi, egg!!'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" HomeController"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h4",{attrs:{id:"controller自定义基类"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#controller自定义基类"}},[t._v("#")]),t._v(" Controller自定义基类")]),t._v(" "),n("p",[t._v("通过自定义Controller基类的方式封装应用中常用的方法；"),n("br"),t._v("\n在编写应用的Controller时，可以继承BaseController，直接使用基类上的方法。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  文件目录：app/core/base_controller.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Controller "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BaseController")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Controller")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("session"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("success")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tsuccess"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t\tdata"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("notFound")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("msg")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tmsg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'not found'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("404")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("msg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BaseController "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h2",{attrs:{id:"service"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[t._v("#")]),t._v(" Service")]),t._v(" "),n("h3",{attrs:{id:"什么是service"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是service"}},[t._v("#")]),t._v(" 什么是Service")]),t._v(" "),n("p",[t._v("简单来说，Service就是在复杂业务场景下用于做业务逻辑封装的一个抽象层，提供这个抽象有以下几个好处：")]),t._v(" "),n("ul",[n("li",[t._v("保持Controller中的逻辑更加简洁。")]),t._v(" "),n("li",[t._v("保持业务逻辑的独立性，抽象出来的Service可以被多个Controller重复利用。")]),t._v(" "),n("li",[t._v("奖逻辑和展现分离，更容易编写测试用例。\n每一次用户请求，框架都会实例化对应的Service实例，拥有下列属性方便我们进行开发:")]),t._v(" "),n("li",[t._v("this.ctx :当前请求的上下文Context对象的实例")]),t._v(" "),n("li",[t._v("this.app  ：当前应用Application对象的实例")]),t._v(" "),n("li",[t._v("this.service :应用定的Service；")]),t._v(" "),n("li",[t._v("this.config  ：应用运行时的配置项。")]),t._v(" "),n("li",[t._v("this.logger  ：logger对象，上面有四个方法。")])]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("所有Service 文件Egg都推荐放在app/service目录下")])]),t._v(" "),n("h3",{attrs:{id:"service类的定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#service类的定义"}},[t._v("#")]),t._v(" service类的定义")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" Service "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Service"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HomeService")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Service")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("echo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'222'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" HomeService"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),n("p",[t._v("1、Service文件必须放在app/service目录，可以支持多级目录，访问的时候可以通过目录名级联访问。\n2、一个Service文件只能包含一个类，这个类需要通过module.exports的方式返回。\n3、Service 需要通过Class方式定义，父类必须是egg.Service。\n4、Service是请求级别的对象，框架在每次请求中首次访问ctx.service.xx时延迟实例化，所以Service中可以通过this.ctx获取到当前请求的上下文。")])]),t._v(" "),n("h1",{attrs:{id:"基础功能（二）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基础功能（二）"}},[t._v("#")]),t._v(" 基础功能（二）")]),t._v(" "),n("h2",{attrs:{id:"配置详解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置详解"}},[t._v("#")]),t._v(" 配置详解")]),t._v(" "),n("p",[t._v("config配置：框架提供了强大且可扩展的配置功能，可以自动合并应用、插件、框架配置，按顺序覆盖，且可以根据环境维护不同配置，合并后的配置可直接从app.config获取。"),n("br"),t._v("\nEgg采用代码管理配置，配置的变更也应该经过review后才能发布，应用包本身是可以部署在多个环境的，只需要指定运行环境即可。")]),t._v(" "),n("h3",{attrs:{id:"多环境配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#多环境配置"}},[t._v("#")]),t._v(" 多环境配置")]),t._v(" "),n("ul",[n("li",[t._v("config.default.js为默认的配置文件，所有环境都会加载这个配置文件。")]),t._v(" "),n("li",[t._v("当指定env时会同时加载对应的配置文件，并覆盖默认配置文件的同名配置。")])]),t._v(" "),n("h3",{attrs:{id:"配置写法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置写法"}},[t._v("#")]),t._v(" 配置写法")]),t._v(" "),n("ul",[n("li",[t._v("配置文件返回的是一个object对象，可以覆盖框架的一些配置，应用也可以将自己业务的配置放到这里方便管理。"),n("br"),t._v("\nmodule.exports 与exports不要同时使用。")]),t._v(" "),n("li",[t._v("配置文件还可以返回一个function，可以接收参数appinfo。Appinfo属性有：pkg => package.json ; name => 应用名，同pkg.name ; baseDir => 应用代码目录； HOME => 用户目录，admin账户为 /home/admin ; root => 应用根目录，只有在local和unittest环境为baseDir，其他均为HOME。")])]),t._v(" "),n("p",[t._v("配置加载顺序："),n("br"),t._v("\n应用、插件、框架都可以定义这些配置，而且目录结构都是一致的，但存在优先级（应用 > 框架 > 插件），相对于此运行环境的优先级会更高。")]),t._v(" "),n("h2",{attrs:{id:"中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#中间件"}},[t._v("#")]),t._v(" 中间件")]),t._v(" "),n("p",[t._v("Egg是基于Koa实现的，所以Egg的中间件形式和Koa的中间件形式是一样的，都是基于洋葱圈模型，每次我们编写一个中间件，就相当于在洋葱外面包了一层。")]),t._v(" "),n("h3",{attrs:{id:"egg中间件编写"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#egg中间件编写"}},[t._v("#")]),t._v(" Egg中间件编写")]),t._v(" "),n("p",[t._v("约定：一个中间件事一个放置在app/middleware目录下的单独文件，它需要exports一个普通的function，接收两个参数：options：中间件的配置项，框架会将app.config[${middlewareName}]传递进来； app：当前应用Application的实例。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 文件目录：app/middleware/XXX.js")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("app")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 中间件的具体code。")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"中间件使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#中间件使用"}},[t._v("#")]),t._v(" 中间件使用")]),t._v(" "),n("ul",[n("li",[t._v("在应用中使用中间件，通过配置来加载自定义中间件，并决定他们的顺序。")]),t._v(" "),n("li",[t._v("在框架和插件中使用中间件，不支持配置文件加载中间件：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//  app.js")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("app")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在中间件最前面插入一个中间件")]),t._v("\n\tapp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("coreMiddleware"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("unshift")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'report'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ul",[n("li",[t._v("直接在app/router.js中实例化和挂载中间件：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" gzip "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("middleware"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("gzip")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" threshold "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\napp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("router"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/needgzip'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" gzip "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("controller"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("ul",[n("li",[t._v("除了应用层加载中间件之外，框架自身和其他的插件也会加载许多中间件。")]),t._v(" "),n("li",[t._v("在框架里面引入Koa中间件生态，需要按照框架的规范来应用加载Koa中间件。")])]),t._v(" "),n("h3",{attrs:{id:"中间件配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#中间件配置"}},[t._v("#")]),t._v(" 中间件配置")]),t._v(" "),n("ul",[n("li",[t._v("无论是应用层加载的中间件还是框架自带中间件，都支持中间件通用配置项。")]),t._v(" "),n("li",[t._v("enable：控制中间件是否开启：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("bodyParser "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tenable"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("match :设置只有符合某些规则的请求才会进过这个中间件；\nignore：设置符合某些规则的请求不经过这个中间件：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// match和ignore不允许同时配置；")]),t._v("\ngzip"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tmatch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/static'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ngzip "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("match")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("ctx")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reg "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/iphone|ipad|ipod/i")]),t._v(" \n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" reg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ctx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user-agent'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"框架扩展"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#框架扩展"}},[t._v("#")]),t._v(" 框架扩展")]),t._v(" "),n("p",[t._v("框架提供了多种扩展点扩展自身的功能\nApplication + Context + Request + Response + Helper")]),t._v(" "),n("ul",[n("li",[t._v("Application 的扩展：框架会把app/extend/application.js 中定义的对象与Koa Application的prototype对象进行合并，在应用启动时会基于扩展后的prototype生成APP对象。")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 推荐使用Symbol +Getter的模式")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BAR")]),t._v("  "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("Symbol")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Application#bar'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("param")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this就是app对象，在其中可以调用app上的其他方法，或访问属性。")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this就是APP对象，在其中可以调用APP上的其他方法，或访问属性，")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("xx "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("yy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BAR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ul",[n("li",[n("p",[t._v("Context扩展\n框架会把app/extend/context.js 中定义的对象与Koa Context的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成ctx对象。\n扩展代码与扩展Application的类似。")])]),t._v(" "),n("li",[n("p",[t._v("Request扩展："),n("br"),t._v("\n框架会把app/extend/request.js中定义的对象与内置对象Request的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成request对象。")])])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("module"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'x-request-foo'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ul",[n("li",[n("p",[t._v("response扩展\n框架会把app/extend/response.js中定义的对象与内置对象Response的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成response对象。")])]),t._v(" "),n("li",[n("p",[t._v("Helper扩展\n框架会把app/extend/helper.js中定义的对象与内置对象helper的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成helper对象。")])])]),t._v(" "),n("h4",{attrs:{id:"按照环境进行扩展"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#按照环境进行扩展"}},[t._v("#")]),t._v(" 按照环境进行扩展")]),t._v(" "),n("ul",[n("li",[t._v("可以根据环境进行有选择的扩展。")]),t._v(" "),n("li",[t._v("以下例子文件，只会在unittest环境加载，同理对于其他内置对象也可以使用这种方式针对某个环境进行扩展。")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app/extend/application.unittest.js")]),t._v("\nmodule"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("XXXXX")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h1",{attrs:{id:"基础功能（三）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基础功能（三）"}},[t._v("#")]),t._v(" 基础功能（三）")]),t._v(" "),n("h1",{attrs:{id:"插件应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#插件应用"}},[t._v("#")]),t._v(" 插件应用")]),t._v(" "),n("h2",{attrs:{id:"插件机制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#插件机制"}},[t._v("#")]),t._v(" 插件机制")]),t._v(" "),n("p",[t._v("插件机制是Egg框架的一大特色，它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。")]),t._v(" "),n("ul",[n("li",[t._v("为什需要插件：\n1、中间件加载是有先后顺序的，但是其自身却无法管理这种顺序，只能交给使用者。"),n("br"),t._v("\n2、中间件的定位是拦截用户请求，但是有些功能与请求无关。"),n("br"),t._v("\n3、有些功能包含非常复杂的初始化逻辑，需要在应用启动的时候完成（中间件是在应用启动之后才加载的，所以中间件无法满足）。"),n("br"),t._v("\n于是Egg就推出了一个更加强大的机制，来管理、编排那些相对独立的业务逻辑。")])]),t._v(" "),n("h3",{attrs:{id:"插件、应用、中间件的关系"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#插件、应用、中间件的关系"}},[t._v("#")]),t._v(" 插件、应用、中间件的关系")]),t._v(" "),n("p",[t._v("一个插件就是一个【迷你应用】，和App结构几乎一致：")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("1、它包含了Service、中间件、配置、框架扩展等。"),n("br"),t._v("\n2、它没有独立的Router和Controller。"),n("br"),t._v("\n3、它没有plugin.js，只能声明跟其他插件的依赖，而不能决定其他插件的开启与否。")])]),t._v(" "),n("p",[t._v("差价与中间件、框架的关系：")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("应用可以直接引入Koa的中间件。\n当遇到上一节提到的场景，则应用需引入插件。\n插件本身可以包含中间件，\n多个插件可以包装为一个上层框架。")])]),t._v(" "),n("h3",{attrs:{id:"使用插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用插件"}},[t._v("#")]),t._v(" 使用插件")]),t._v(" "),n("ul",[n("li",[t._v("插件一般通过npm模块的方式进行复用。然后需要在应用或框架的config/plugin.js中声明。")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//config/plugin.js")]),t._v("\nexports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mysql "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tenbale"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg-mysql'")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("ul",[n("li",[t._v("接下来就可以直接使用插件提供的功能了。")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("app"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mysql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("query")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sql"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("values"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h3",{attrs:{id:"插件配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#插件配置"}},[t._v("#")]),t._v(" 插件配置")]),t._v(" "),n("p",[t._v("配置项支持：")]),t._v(" "),n("ul",[n("li",[t._v("enable - {Boolean} 是否开启此插件，默认为true。")]),t._v(" "),n("li",[t._v("package - {String} npm模块名称，通过npm 模块形式引入的插件")]),t._v(" "),n("li",[t._v("path - {String} 插件绝对路径，跟package配置互斥。")]),t._v(" "),n("li",[t._v("env - {Array} 只有在指定运行环境才能开启，会覆盖插件自身package.json中的配置。"),n("br"),t._v("\n还支持plugin.{env}.js这种模式，会根据运行环境加载插件配置：")])]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//config/plugin.local.js")]),t._v("\nexports"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dev "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tenable "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg-dev'")]),t._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"内置插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内置插件"}},[t._v("#")]),t._v(" 内置插件")]),t._v(" "),n("ul",[n("li",[t._v("view 模板引擎")]),t._v(" "),n("li",[t._v("onerror 统一异常处理")]),t._v(" "),n("li",[t._v("Session Session实现")]),t._v(" "),n("li",[t._v("i18n 多语言")]),t._v(" "),n("li",[t._v("watcher 文件和文件夹监控")]),t._v(" "),n("li",[t._v("……")])]),t._v(" "),n("h2",{attrs:{id:"模板渲染"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模板渲染"}},[t._v("#")]),t._v(" 模板渲染")]),t._v(" "),n("p",[t._v("绝大多数情况，我们都需要读取数据后渲染模板，然后呈现给用户，因此我们需要引入对应的模板引擎。"),n("br"),t._v("\n框架内置egg-view作为模板解决方案，并支持多模板渲染，每个模板引擎都以插件的方式引入，但保持渲染的api一致。"),n("br"),t._v("\n使用模板引擎")]),t._v(" "),n("ul",[n("li",[t._v("引入view插件")]),t._v(" "),n("li",[t._v("启用插件")]),t._v(" "),n("li",[t._v("配置view插件"),n("br"),t._v("\nconfig.view :"),n("br"),t._v("\nroot{String} 模板文件的目录，为绝对路径，默认${baseDir}/app/view 。"),n("br"),t._v("\ncache{Boolean} 模板路径缓存，默认开启，框架根据root配置的目录一次查找。"),n("br"),t._v("\nmapping 每个模板在注册时会指定一个模板名，使用时根据后缀匹配模板名。"),n("br"),t._v("\ndefaultViewEngine 配置全局mapping")])]),t._v(" "),n("h2",{attrs:{id:"onerror插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#onerror插件"}},[t._v("#")]),t._v(" onerror插件")]),t._v(" "),n("p",[t._v("框架通过onerror插件提供了统一错误处理机制，对于一个请求的所有处理方法，（Middleware、Controller、Service）中抛出的任何异常都会被它捕获，并自动根据请求想要获取的类型返回不同类型的错误。")])])}),[],!1,null,null,null);s.default=e.exports}}]);