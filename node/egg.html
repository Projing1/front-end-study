<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>egg基础概念 | 前端学习笔记</title>
    <meta name="description" content="前端学习中的一些笔记及总结">
    <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/front-end-study/assets/css/0.styles.32c38af2.css" as="style"><link rel="preload" href="/front-end-study/assets/js/app.8d50f10d.js" as="script"><link rel="preload" href="/front-end-study/assets/js/2.8d937a8c.js" as="script"><link rel="preload" href="/front-end-study/assets/js/8.203521e2.js" as="script"><link rel="prefetch" href="/front-end-study/assets/js/10.f52eda7c.js"><link rel="prefetch" href="/front-end-study/assets/js/11.2a207987.js"><link rel="prefetch" href="/front-end-study/assets/js/12.01aa28b7.js"><link rel="prefetch" href="/front-end-study/assets/js/13.4527883c.js"><link rel="prefetch" href="/front-end-study/assets/js/14.c3b7450d.js"><link rel="prefetch" href="/front-end-study/assets/js/15.d4d389ff.js"><link rel="prefetch" href="/front-end-study/assets/js/16.a3638bd2.js"><link rel="prefetch" href="/front-end-study/assets/js/17.54f21fd6.js"><link rel="prefetch" href="/front-end-study/assets/js/18.3eb8d134.js"><link rel="prefetch" href="/front-end-study/assets/js/19.f7a3a423.js"><link rel="prefetch" href="/front-end-study/assets/js/20.79486553.js"><link rel="prefetch" href="/front-end-study/assets/js/21.978f0a17.js"><link rel="prefetch" href="/front-end-study/assets/js/22.6223d7e6.js"><link rel="prefetch" href="/front-end-study/assets/js/23.08148677.js"><link rel="prefetch" href="/front-end-study/assets/js/24.4b066b56.js"><link rel="prefetch" href="/front-end-study/assets/js/25.afa98a0a.js"><link rel="prefetch" href="/front-end-study/assets/js/26.1dd01e6e.js"><link rel="prefetch" href="/front-end-study/assets/js/27.87c9010a.js"><link rel="prefetch" href="/front-end-study/assets/js/3.6cf61e10.js"><link rel="prefetch" href="/front-end-study/assets/js/4.b1577da0.js"><link rel="prefetch" href="/front-end-study/assets/js/5.bdaf13af.js"><link rel="prefetch" href="/front-end-study/assets/js/6.f4717c6c.js"><link rel="prefetch" href="/front-end-study/assets/js/7.996d1dce.js"><link rel="prefetch" href="/front-end-study/assets/js/9.0a94c988.js">
    <link rel="stylesheet" href="/front-end-study/assets/css/0.styles.32c38af2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/front-end-study/" class="home-link router-link-active"><!----> <span class="site-name">前端学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-study/guide/" class="nav-link">高级前端开发课程</a></div><div class="nav-item"><a href="/front-end-study/config/" class="nav-link">实际项目中的错误汇总</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end-study/guide/" class="nav-link">高级前端开发课程</a></div><div class="nav-item"><a href="/front-end-study/config/" class="nav-link">实际项目中的错误汇总</a></div><div class="nav-item"><a href="https://www.vuepress.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>单页应用专题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>H5移动端开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Node开发导学</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end-study/node/ES6.html" class="sidebar-link">ES6快速入门</a></li><li><a href="/front-end-study/node/Node.html" class="sidebar-link">nodejs静态服务器搭建</a></li><li><a href="/front-end-study/node/Linux.html" class="sidebar-link">Linux快速上手</a></li><li><a href="/front-end-study/node/Nginx.html" class="sidebar-link">Nginx入门</a></li><li><a href="/front-end-study/node/Redis.html" class="sidebar-link">Redis入门</a></li><li><a href="/front-end-study/node/communication.html" class="sidebar-link">通信协议详解</a></li><li><a href="/front-end-study/node/egg.html" class="active sidebar-link">eggJs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#内置对象" class="sidebar-link">内置对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#继承自koa的内置对象：" class="sidebar-link">继承自Koa的内置对象：</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#egg自身扩展的对象：" class="sidebar-link">Egg自身扩展的对象：</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#运行环境" class="sidebar-link">运行环境</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#运行环境指定和获取" class="sidebar-link">运行环境指定和获取</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#egg-server-env" class="sidebar-link">EGGSERVERENV</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#路由" class="sidebar-link">路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#路由定义" class="sidebar-link">路由定义</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#restful风格api定义" class="sidebar-link">RESTful风格API定义</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#控制器" class="sidebar-link">控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#什么是controller" class="sidebar-link">什么是Controller</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#controller负责做什么" class="sidebar-link">Controller负责做什么</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#controller的定义" class="sidebar-link">Controller的定义</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#service" class="sidebar-link">Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#什么是service" class="sidebar-link">什么是Service</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#service类的定义" class="sidebar-link">service类的定义</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#配置详解" class="sidebar-link">配置详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#多环境配置" class="sidebar-link">多环境配置</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#配置写法" class="sidebar-link">配置写法</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#中间件" class="sidebar-link">中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#egg中间件编写" class="sidebar-link">Egg中间件编写</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#中间件使用" class="sidebar-link">中间件使用</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#中间件配置" class="sidebar-link">中间件配置</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#框架扩展" class="sidebar-link">框架扩展</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#插件机制" class="sidebar-link">插件机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#插件、应用、中间件的关系" class="sidebar-link">插件、应用、中间件的关系</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#使用插件" class="sidebar-link">使用插件</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#插件配置" class="sidebar-link">插件配置</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#内置插件" class="sidebar-link">内置插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#模板渲染" class="sidebar-link">模板渲染</a></li><li class="sidebar-sub-header"><a href="/front-end-study/node/egg.html#onerror插件" class="sidebar-link">onerror插件</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="egg基础概念"><a href="#egg基础概念" class="header-anchor">#</a> egg基础概念</h1> <h2 id="内置对象"><a href="#内置对象" class="header-anchor">#</a> 内置对象</h2> <h3 id="继承自koa的内置对象："><a href="#继承自koa的内置对象：" class="header-anchor">#</a> 继承自Koa的内置对象：</h3> <ul><li>Application : 全局应用对象，在一个应用中，只会实例化一个，允许在它上面挂载一些全局方法和对象。在编写应用时，几乎在任何一个地方都能获取Application对象。</li> <li>Context :最常见的获取方式是在Middleware,Controller,以及Service中；Controller中的获取Context ; Service中获取Context; Middleware中获取Context</li> <li>Request ：Request 是一个请求级别的对象，与Koa一样，Egg中会在Context上代理一部分Request和Response上的方法和属性。</li> <li>Response： Response是一个请求级别的对象。<br>
ctx.request.query和ctx.query是等价的，ctx.response.body和ctx.body是等价的。<br>
获取请求对象的body应该使用ctx.request.body ,而不是ctx.body;</li></ul> <h3 id="egg自身扩展的对象："><a href="#egg自身扩展的对象：" class="header-anchor">#</a> Egg自身扩展的对象：</h3> <ul><li><p>Controller :Egg提供了一个Controller基类，并推荐所有的Controller继承于该基类实现。</p></li> <li><p>Service： Egg提供了一个Service基类，并推荐所有的Service继承于该基类实现。<br>
这两个基类都有如下属性： ctx:当前请求的上下文实例。app:应用的Application 实例。config：应用的配置项。service：应用所有的Service。 controller:应用所有的controller。 logger：为当前实例封装的logger对象。</p></li> <li><p>Helper：Helper用来提供一些实用的utility函数。我们可以将一些常用的动作抽离在helper.js里面成为一个独立的函数。在Context的实例上获取到当前请求的Helper实例。Helper实例还可以在模板中获取到。</p></li> <li><p>Config：Egg推荐应用开发遵循配置和代码分离的原则。配置文件支持各个不同的运行环境使用不同的配置。所有框架、插件和应用级别的配置都可以通过Config对象获取到。</p></li> <li><p>Logger： Logger对象有4个方法：logger.debug()、logger.info()、logger.warn()、logger.error();<br>
在框架中提供了多个Logger对象：</p></li> <li><p>App CoreLogger: 框架和插件需要通过它来打印应用级别的日志。</p></li> <li><p>Context Logger：与请求相关的，在前面带上一些当前请求相关的信息。</p></li> <li><p>Context CoreLogger： 一般只有插件和框架会通过它来记录请求日志。</p></li> <li><p>Controller Logger和Service Logger：其本质是一个Context Logger。</p></li></ul> <h2 id="运行环境"><a href="#运行环境" class="header-anchor">#</a> 运行环境</h2> <h3 id="运行环境指定和获取"><a href="#运行环境指定和获取" class="header-anchor">#</a> 运行环境指定和获取</h3> <p>配置环境的两种方式：</p> <ul><li>通过config/env文件指定，该文件的内容就是运行环境：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//config/env  (文件在config文件夹下，名叫env的文件，文件里只写环境名称，不可以写注释)</span>
prod
</code></pre></div><ul><li>通过'EGG_SERVER_ENV' 环境变量指定运行环境更加方便，比如在生产环境启动应用：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">EGG_SERVER_ENV</span><span class="token operator">=</span>prod npm start
</code></pre></div><p>框架提供了变量app.config.env 来表示应用当前的运行环境。</p> <p>一个web应用本身应该是无状态的，并拥有根据运行环境设置自身的能力。</p> <h3 id="egg-server-env"><a href="#egg-server-env" class="header-anchor">#</a> EGG_SERVER_ENV</h3> <ul><li>很多node.js应用会使用NODE_ENV 来区分运行环境。</li> <li>npm也会使用这个变量，在应用部署的时候一般不会安装开发依赖；</li> <li>Egg支持自定义环境来适应自己的开发流程。</li> <li>在Koa中我们通过app.env来进行判断，在Egg中，配置统一都放置在app.config 上；</li></ul> <table><thead><tr><th style="text-align:center;">NODE_ENV</th> <th style="text-align:center;">EGG_SERVER_ENV</th> <th style="text-align:center;">注解</th></tr></thead> <tbody><tr><td style="text-align:center;"></td> <td style="text-align:center;">local</td> <td style="text-align:center;">本地开发环境</td></tr> <tr><td style="text-align:center;">test</td> <td style="text-align:center;">unittest</td> <td style="text-align:center;">单元测试</td></tr> <tr><td style="text-align:center;">production</td> <td style="text-align:center;">prod</td> <td style="text-align:center;">生产环境</td></tr></tbody></table> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <p><a href="https://eggjs.org/zh-cn/basics/structure.html" target="_blank" rel="noopener noreferrer">egg项目目录结构<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>；</p> <h1 id="基础功能"><a href="#基础功能" class="header-anchor">#</a> 基础功能</h1> <h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <ul><li>Router主要用来描述请求URL和具体承担执行动作的Controller的对应关系，框架约定了app/router.js文件用于统一所有路由规则。</li> <li>通过统一的配置，我们可以避免路由规则逻辑散落在多个地方，从而出现未知的冲突，集中在一起我们可以更方便的来查看全局的路由规则。</li></ul> <h3 id="路由定义"><a href="#路由定义" class="header-anchor">#</a> 路由定义</h3> <ul><li>app/router.js里面定义URL路由规则</li> <li>app/controller 目录下面实现Controller</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由js的样例。</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
	router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/getHelloInfo'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="路由的详细定义"><a href="#路由的详细定义" class="header-anchor">#</a> 路由的详细定义</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// verb-用户触发动作，支持GET，POST等所有HTTP方法</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'path-match'</span> <span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// router-name给路由设定一个别名。 path-match -路由URL；</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'router-name'</span> <span class="token punctuation">,</span> <span class="token string">'path-match'</span><span class="token punctuation">,</span>app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// middleware -在Router里面可以配置多个Middleware。 controller -指定路由映射到的具体controller上。</span>
router<span class="token punctuation">.</span><span class="token function">verb</span><span class="token punctuation">(</span><span class="token string">'router-name'</span><span class="token punctuation">,</span><span class="token string">'path-match'</span> <span class="token punctuation">,</span>middleware1 <span class="token punctuation">,</span>middleware2 <span class="token punctuation">,</span> …… <span class="token punctuation">,</span> middlewareN <span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="restful风格api定义"><a href="#restful风格api定义" class="header-anchor">#</a> RESTful风格API定义</h3> <p>Egg提供了app.router.resources快速在一个路径上生成一个CRUD路由结构。
<img src="/front-end-study/assets/img/restful.359c1584.png" alt="restful风格api">;</p> <h2 id="控制器"><a href="#控制器" class="header-anchor">#</a> 控制器</h2> <h3 id="什么是controller"><a href="#什么是controller" class="header-anchor">#</a> 什么是Controller</h3> <p>Egg通过Router将用户的请求基于method和url分发到了对应的Controller上，简单的说Controller负责解析用户的输入，处理后返回相应的结果。</p> <ul><li>在RESTful接口中，Controller接受用户的参数，从数据库中查找内容返回给用户或者将用户的请求更新到数据库中。</li> <li>在HTML页面请求中，Controller根据用户访问不同的URL，渲染不同的模板得到HTML返回给用户。</li> <li>在代理服务器中，Controller将用户的请求转发到其他服务器上，并将其他服务器的处理结果返回给用户。</li></ul> <h3 id="controller负责做什么"><a href="#controller负责做什么" class="header-anchor">#</a> Controller负责做什么</h3> <p>框架推荐Controller层主要对用户的请求参数进行处理，然后调用对应的Service方法处理业务，得到业务结果后封装并返回。</p> <ul><li>1、获取用户通过HTTP传递过来的请求参数。</li> <li>2、校验、组装参数。</li> <li>3、调用Service进行业务处理，必要时处理转换Service的返回结果，让它适应用户的需求。</li> <li>4、通过HTTP将结果响应给用户。</li></ul> <h3 id="controller的定义"><a href="#controller的定义" class="header-anchor">#</a> Controller的定义</h3> <p>定义Controller类，会在每一个请求进来的时候实例化一个全新的对象，会有下面几个属性挂在this上：</p> <ul><li>this.ctx :当前请求的上下文Context对象的实例</li> <li>this.app  ：当前应用Application对象的实例</li> <li>this.service :应用定的Service；</li> <li>this.config  ：应用运行时的配置项。</li> <li>this.logger  ：logger对象，上面有四个方法。</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>所有的Controller文件都必须放在app/controller 目录下。</p></div> <h4 id="controller类的写法："><a href="#controller类的写法：" class="header-anchor">#</a> Controller类的写法：</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
   <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
   	<span class="token comment">// 实现用户参数获取，校验、组装参数等；调用service进行业务处理，通过http将结果返回给用户。</span>
   	ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hi, egg!!'</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span>
</code></pre></div><h4 id="controller自定义基类"><a href="#controller自定义基类" class="header-anchor">#</a> Controller自定义基类</h4> <p>通过自定义Controller基类的方式封装应用中常用的方法；<br>
在编写应用的Controller时，可以继承BaseController，直接使用基类上的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  文件目录：app/core/base_controller.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>  <span class="token punctuation">{</span>
	<span class="token keyword">get</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
			success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			data<span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">notFound</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'not found'</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span> <span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController <span class="token punctuation">;</span>
</code></pre></div><h2 id="service"><a href="#service" class="header-anchor">#</a> Service</h2> <h3 id="什么是service"><a href="#什么是service" class="header-anchor">#</a> 什么是Service</h3> <p>简单来说，Service就是在复杂业务场景下用于做业务逻辑封装的一个抽象层，提供这个抽象有以下几个好处：</p> <ul><li>保持Controller中的逻辑更加简洁。</li> <li>保持业务逻辑的独立性，抽象出来的Service可以被多个Controller重复利用。</li> <li>奖逻辑和展现分离，更容易编写测试用例。
每一次用户请求，框架都会实例化对应的Service实例，拥有下列属性方便我们进行开发:</li> <li>this.ctx :当前请求的上下文Context对象的实例</li> <li>this.app  ：当前应用Application对象的实例</li> <li>this.service :应用定的Service；</li> <li>this.config  ：应用运行时的配置项。</li> <li>this.logger  ：logger对象，上面有四个方法。</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>所有Service 文件Egg都推荐放在app/service目录下</p></div> <h3 id="service类的定义"><a href="#service类的定义" class="header-anchor">#</a> service类的定义</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomeService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
	<span class="token keyword">async</span> <span class="token function">echo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'222'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeService<span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>1、Service文件必须放在app/service目录，可以支持多级目录，访问的时候可以通过目录名级联访问。
2、一个Service文件只能包含一个类，这个类需要通过module.exports的方式返回。
3、Service 需要通过Class方式定义，父类必须是egg.Service。
4、Service是请求级别的对象，框架在每次请求中首次访问ctx.service.xx时延迟实例化，所以Service中可以通过this.ctx获取到当前请求的上下文。</p></div> <h1 id="基础功能（二）"><a href="#基础功能（二）" class="header-anchor">#</a> 基础功能（二）</h1> <h2 id="配置详解"><a href="#配置详解" class="header-anchor">#</a> 配置详解</h2> <p>config配置：框架提供了强大且可扩展的配置功能，可以自动合并应用、插件、框架配置，按顺序覆盖，且可以根据环境维护不同配置，合并后的配置可直接从app.config获取。<br>
Egg采用代码管理配置，配置的变更也应该经过review后才能发布，应用包本身是可以部署在多个环境的，只需要指定运行环境即可。</p> <h3 id="多环境配置"><a href="#多环境配置" class="header-anchor">#</a> 多环境配置</h3> <ul><li>config.default.js为默认的配置文件，所有环境都会加载这个配置文件。</li> <li>当指定env时会同时加载对应的配置文件，并覆盖默认配置文件的同名配置。</li></ul> <h3 id="配置写法"><a href="#配置写法" class="header-anchor">#</a> 配置写法</h3> <ul><li>配置文件返回的是一个object对象，可以覆盖框架的一些配置，应用也可以将自己业务的配置放到这里方便管理。<br>
module.exports 与exports不要同时使用。</li> <li>配置文件还可以返回一个function，可以接收参数appinfo。Appinfo属性有：pkg =&gt; package.json ; name =&gt; 应用名，同pkg.name ; baseDir =&gt; 应用代码目录； HOME =&gt; 用户目录，admin账户为 /home/admin ; root =&gt; 应用根目录，只有在local和unittest环境为baseDir，其他均为HOME。</li></ul> <p>配置加载顺序：<br>
应用、插件、框架都可以定义这些配置，而且目录结构都是一致的，但存在优先级（应用 &gt; 框架 &gt; 插件），相对于此运行环境的优先级会更高。</p> <h2 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h2> <p>Egg是基于Koa实现的，所以Egg的中间件形式和Koa的中间件形式是一样的，都是基于洋葱圈模型，每次我们编写一个中间件，就相当于在洋葱外面包了一层。</p> <h3 id="egg中间件编写"><a href="#egg中间件编写" class="header-anchor">#</a> Egg中间件编写</h3> <p>约定：一个中间件事一个放置在app/middleware目录下的单独文件，它需要exports一个普通的function，接收两个参数：options：中间件的配置项，框架会将app.config[${middlewareName}]传递进来； app：当前应用Application的实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 文件目录：app/middleware/XXX.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token punctuation">,</span>app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">gzip</span><span class="token punctuation">(</span><span class="token parameter">ctx <span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 中间件的具体code。</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="中间件使用"><a href="#中间件使用" class="header-anchor">#</a> 中间件使用</h3> <ul><li>在应用中使用中间件，通过配置来加载自定义中间件，并决定他们的顺序。</li> <li>在框架和插件中使用中间件，不支持配置文件加载中间件：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  app.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	<span class="token comment">// 在中间件最前面插入一个中间件</span>
	app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>coreMiddleware<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token string">'report'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>直接在app/router.js中实例化和挂载中间件：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> gzip <span class="token operator">=</span> app<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">gzip</span><span class="token punctuation">(</span><span class="token punctuation">{</span> threshold <span class="token punctuation">:</span><span class="token number">1024</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/needgzip'</span> <span class="token punctuation">,</span> gzip <span class="token punctuation">,</span>app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>除了应用层加载中间件之外，框架自身和其他的插件也会加载许多中间件。</li> <li>在框架里面引入Koa中间件生态，需要按照框架的规范来应用加载Koa中间件。</li></ul> <h3 id="中间件配置"><a href="#中间件配置" class="header-anchor">#</a> 中间件配置</h3> <ul><li>无论是应用层加载的中间件还是框架自带中间件，都支持中间件通用配置项。</li> <li>enable：控制中间件是否开启：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>bodyParser <span class="token punctuation">:</span> <span class="token punctuation">{</span>
	enable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>match :设置只有符合某些规则的请求才会进过这个中间件；
ignore：设置符合某些规则的请求不经过这个中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// match和ignore不允许同时配置；</span>
gzip<span class="token punctuation">:</span><span class="token punctuation">{</span>
	match<span class="token punctuation">:</span> <span class="token string">'/static'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

gzip <span class="token punctuation">:</span><span class="token punctuation">{</span>
	<span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex">/iphone|ipad|ipod/i</span> 
		<span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="框架扩展"><a href="#框架扩展" class="header-anchor">#</a> 框架扩展</h3> <p>框架提供了多种扩展点扩展自身的功能
Application + Context + Request + Response + Helper</p> <ul><li>Application 的扩展：框架会把app/extend/application.js 中定义的对象与Koa Application的prototype对象进行合并，在应用启动时会基于扩展后的prototype生成APP对象。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 推荐使用Symbol +Getter的模式</span>
<span class="token keyword">const</span> <span class="token constant">BAR</span>  <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'Application#bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// this就是app对象，在其中可以调用app上的其他方法，或访问属性。</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// this就是APP对象，在其中可以调用APP上的其他方法，或访问属性，</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>xx <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>yy<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">BAR</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>Context扩展
框架会把app/extend/context.js 中定义的对象与Koa Context的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成ctx对象。
扩展代码与扩展Application的类似。</p></li> <li><p>Request扩展：<br>
框架会把app/extend/request.js中定义的对象与内置对象Request的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成request对象。</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">get</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'x-request-foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>response扩展
框架会把app/extend/response.js中定义的对象与内置对象Response的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成response对象。</p></li> <li><p>Helper扩展
框架会把app/extend/helper.js中定义的对象与内置对象helper的prototype对象进行合并，在处理请求时会基于扩展后的prototype生成helper对象。</p></li></ul> <h4 id="按照环境进行扩展"><a href="#按照环境进行扩展" class="header-anchor">#</a> 按照环境进行扩展</h4> <ul><li>可以根据环境进行有选择的扩展。</li> <li>以下例子文件，只会在unittest环境加载，同理对于其他内置对象也可以使用这种方式针对某个环境进行扩展。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/extend/application.unittest.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token constant">XXXXX</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="基础功能（三）"><a href="#基础功能（三）" class="header-anchor">#</a> 基础功能（三）</h1> <h1 id="插件应用"><a href="#插件应用" class="header-anchor">#</a> 插件应用</h1> <h2 id="插件机制"><a href="#插件机制" class="header-anchor">#</a> 插件机制</h2> <p>插件机制是Egg框架的一大特色，它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。</p> <ul><li>为什需要插件：
1、中间件加载是有先后顺序的，但是其自身却无法管理这种顺序，只能交给使用者。<br>
2、中间件的定位是拦截用户请求，但是有些功能与请求无关。<br>
3、有些功能包含非常复杂的初始化逻辑，需要在应用启动的时候完成（中间件是在应用启动之后才加载的，所以中间件无法满足）。<br>
于是Egg就推出了一个更加强大的机制，来管理、编排那些相对独立的业务逻辑。</li></ul> <h3 id="插件、应用、中间件的关系"><a href="#插件、应用、中间件的关系" class="header-anchor">#</a> 插件、应用、中间件的关系</h3> <p>一个插件就是一个【迷你应用】，和App结构几乎一致：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>1、它包含了Service、中间件、配置、框架扩展等。<br>
2、它没有独立的Router和Controller。<br>
3、它没有plugin.js，只能声明跟其他插件的依赖，而不能决定其他插件的开启与否。</p></div> <p>差价与中间件、框架的关系：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>应用可以直接引入Koa的中间件。
当遇到上一节提到的场景，则应用需引入插件。
插件本身可以包含中间件，
多个插件可以包装为一个上层框架。</p></div> <h3 id="使用插件"><a href="#使用插件" class="header-anchor">#</a> 使用插件</h3> <ul><li>插件一般通过npm模块的方式进行复用。然后需要在应用或框架的config/plugin.js中声明。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//config/plugin.js</span>
exports<span class="token punctuation">.</span>mysql <span class="token operator">=</span> <span class="token punctuation">{</span>
	enbale<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-mysql'</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>接下来就可以直接使用插件提供的功能了。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span>values<span class="token punctuation">)</span>
</code></pre></div><h3 id="插件配置"><a href="#插件配置" class="header-anchor">#</a> 插件配置</h3> <p>配置项支持：</p> <ul><li>enable - {Boolean} 是否开启此插件，默认为true。</li> <li>package - {String} npm模块名称，通过npm 模块形式引入的插件</li> <li>path - {String} 插件绝对路径，跟package配置互斥。</li> <li>env - {Array} 只有在指定运行环境才能开启，会覆盖插件自身package.json中的配置。<br>
还支持plugin.{env}.js这种模式，会根据运行环境加载插件配置：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//config/plugin.local.js</span>
exports<span class="token punctuation">.</span>dev <span class="token operator">=</span> <span class="token punctuation">{</span>
	enable <span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token keyword">package</span> <span class="token punctuation">:</span> <span class="token string">'egg-dev'</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="内置插件"><a href="#内置插件" class="header-anchor">#</a> 内置插件</h3> <ul><li>view 模板引擎</li> <li>onerror 统一异常处理</li> <li>Session Session实现</li> <li>i18n 多语言</li> <li>watcher 文件和文件夹监控</li> <li>……</li></ul> <h2 id="模板渲染"><a href="#模板渲染" class="header-anchor">#</a> 模板渲染</h2> <p>绝大多数情况，我们都需要读取数据后渲染模板，然后呈现给用户，因此我们需要引入对应的模板引擎。<br>
框架内置egg-view作为模板解决方案，并支持多模板渲染，每个模板引擎都以插件的方式引入，但保持渲染的api一致。<br>
使用模板引擎</p> <ul><li>引入view插件</li> <li>启用插件</li> <li>配置view插件<br>
config.view :<br>
root{String} 模板文件的目录，为绝对路径，默认${baseDir}/app/view 。<br>
cache{Boolean} 模板路径缓存，默认开启，框架根据root配置的目录一次查找。<br>
mapping 每个模板在注册时会指定一个模板名，使用时根据后缀匹配模板名。<br>
defaultViewEngine 配置全局mapping</li></ul> <h2 id="onerror插件"><a href="#onerror插件" class="header-anchor">#</a> onerror插件</h2> <p>框架通过onerror插件提供了统一错误处理机制，对于一个请求的所有处理方法，（Middleware、Controller、Service）中抛出的任何异常都会被它捕获，并自动根据请求想要获取的类型返回不同类型的错误。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/front-end-study/node/communication.html" class="prev">通信协议详解</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/front-end-study/assets/js/app.8d50f10d.js" defer></script><script src="/front-end-study/assets/js/2.8d937a8c.js" defer></script><script src="/front-end-study/assets/js/8.203521e2.js" defer></script>
  </body>
</html>
